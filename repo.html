<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Repository</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<main>
  <h2 id="repoTitle"></h2>

  <!-- Controls -->
  <button onclick="newFile()">+ New File</button>
  <button onclick="togglePreview()">Toggle Preview</button>
  <button onclick="commit()">Commit</button>
  <button onclick="openClient()">Open in Client</button>

  <!-- File tree + editor -->
  <div class="container">
    <div class="files" id="fileList"></div>

    <div style="flex:1">
      <h3 id="fileName"></h3>
      <textarea id="editor"></textarea>
      <div id="preview" style="display:none; padding:10px;"></div>
    </div>
  </div>
</main>

<script>
/************* GLOBAL VARIABLES *************/
let repos = JSON.parse(localStorage.getItem("repos"));
let repoIndex = localStorage.getItem("currentRepo");
let repo = repos[repoIndex];
let currentFile = null;
let preview = false;

// Show repo title
document.getElementById("repoTitle").innerText = repo.name;

// Ensure repo has files
repo.files ||= [];

/************* FILE TREE *************/
function renderFiles() {
  const list = document.getElementById("fileList");
  list.innerHTML = "";
  repo.files.forEach((f, i) => {
    const div = document.createElement("div");
    div.innerText = f.path;
    div.onclick = () => openFile(i);
    list.appendChild(div);
  });
}

function openFile(i) {
  currentFile = repo.files[i];
  document.getElementById("fileName").innerText = currentFile.path;
  document.getElementById("editor").value = currentFile.content;
  updatePreview();
}

/************* EDITOR & PREVIEW *************/
function togglePreview() {
  preview = !preview;
  document.getElementById("editor").style.display = preview ? "none" : "block";
  document.getElementById("preview").style.display = preview ? "block" : "none";
  updatePreview();
}

function updatePreview() {
  if (!currentFile) return;

  if (currentFile.path.endsWith(".md")) {
    document.getElementById("preview").innerHTML =
      marked.parse(document.getElementById("editor").value);
  } else if (currentFile.path.endsWith(".html")) {
    document.getElementById("preview").innerHTML =
      document.getElementById("editor").value;
  } else {
    document.getElementById("preview").innerText =
      "Preview only for .md or .html files";
  }
}

/************* FILE MANAGEMENT *************/
function newFile() {
  const path = prompt("File path (example: src/main.js)");
  if (!path) return;

  repo.files.push({ path, content: "" });
  save();
  renderFiles();
  openFile(repo.files.length - 1);
}

function commit() {
  if (!currentFile) return;
  currentFile.content = document.getElementById("editor").value;
  save();
  alert("Committed âœ”");
}

/************* OPEN IN CLIENT *************/
function openClient() {
  if (!repo) return;
  const url = `client.html?repo=${repoIndex}`;
  window.open(url, "_blank");
}

/************* SAVE FUNCTION *************/
function save() {
  localStorage.setItem("repos", JSON.stringify(repos));
}

// Auto-save every 5 seconds
setInterval(() => {
  if (currentFile) {
    currentFile.content = document.getElementById("editor").value;
    save();
  }
}, 5000);

/************* INITIALIZATION *************/
renderFiles();
if (repo.files.length > 0) openFile(0);

</script>
</body>
</html>
