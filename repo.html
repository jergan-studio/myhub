<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Repository</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>

<main>
  <h2 id="repoTitle"></h2>

  <button onclick="newFile()">+ New File</button>
  <button onclick="togglePreview()">Toggle Preview</button>
  <button onclick="commit()">Commit</button>

  <div class="container">
    <div class="files" id="fileList"></div>

    <div style="flex:1">
      <h3 id="fileName"></h3>
      <textarea id="editor"></textarea>
      <div id="preview" style="display:none; padding:10px;"></div>
    </div>
  </div>
</main>

<script>
let repos = JSON.parse(localStorage.getItem("repos"));
let repoIndex = localStorage.getItem("currentRepo");
let repo = repos[repoIndex];
let currentFile = null;
let preview = false;

document.getElementById("repoTitle").innerText = repo.name;

function renderFiles() {
  const list = document.getElementById("fileList");
  list.innerHTML = "";
  repo.files.forEach((f, i) => {
    const div = document.createElement("div");
    div.innerText = f.path;
    div.onclick = () => openFile(i);
    list.appendChild(div);
  });
}

function openFile(i) {
  currentFile = repo.files[i];
  document.getElementById("fileName").innerText = currentFile.path;
  document.getElementById("editor").value = currentFile.content;
  updatePreview();
}

function newFile() {
  const path = prompt("File path (example: src/main.js)");
  if (!path) return;
  repo.files.push({ path, content: "" });
  save();
  renderFiles();
}

function commit() {
  if (!currentFile) return;
  currentFile.content = document.getElementById("editor").value;
  save();
  alert("Committed âœ”");
}

function togglePreview() {
  preview = !preview;
  document.getElementById("editor").style.display = preview ? "none" : "block";
  document.getElementById("preview").style.display = preview ? "block" : "none";
  updatePreview();
}

function updatePreview() {
  if (!currentFile) return;
  if (currentFile.path.endsWith(".md")) {
    document.getElementById("preview").innerHTML =
      marked.parse(document.getElementById("editor").value);
  } else {
    document.getElementById("preview").innerText =
      "Preview only for .md files";
  }
}

function save() {
  localStorage.setItem("repos", JSON.stringify(repos));
}

// auto-save
setInterval(() => {
  if (currentFile) {
    currentFile.content = document.getElementById("editor").value;
    save();
  }
}, 5000);

renderFiles();
openFile(0);
</script>

</body>
</html>
